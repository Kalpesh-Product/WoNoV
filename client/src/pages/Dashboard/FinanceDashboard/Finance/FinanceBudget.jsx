import React from "react";
import dayjs from "dayjs";
import LayerBarGraph from "../../../../components/graphs/LayerBarGraph";
import WidgetSection from "../../../../components/WidgetSection";
import Accordion from "@mui/material/Accordion";
import AccordionSummary from "@mui/material/AccordionSummary";
import AccordionDetails from "@mui/material/AccordionDetails";
import { IoIosArrowDown } from "react-icons/io";
import AgTable from "../../../../components/AgTable";
import PrimaryButton from "../../../../components/PrimaryButton";
import DataCard from "../../../../components/DataCard";
import { MdTrendingUp } from "react-icons/md";
import { BsCheckCircleFill } from "react-icons/bs";
import AllocatedBudget from "../../../../components/Tables/AllocatedBudget";
import useAxiosPrivate from "../../../../hooks/useAxiosPrivate";
import { useQuery } from "@tanstack/react-query";

const FinanceBudget = () => {
  const axios = useAxiosPrivate();
    
       const { data: hrFinance = [] } = useQuery({
          queryKey: ["hrFinance"],
          queryFn: async () => {
            try {
              const response = await axios.get(
                `/api/budget/company-budget?departmentId=6798bab9e469e809084e249e
                `
              );
              return response.data.allBudgets;
            } catch (error) {
              throw new Error("Error fetching data");
            }
          },
        });

  // Data for the chart
  const utilisedData = [125, 150, 99, 85, 70, 50, 80, 95, 100, 65, 50, 120];
  const defaultData = utilisedData.map((value) =>
    Math.max(100 - Math.min(value, 100), 0)
  );
  const utilisedStack = utilisedData.map((value) => Math.min(value, 100));
  const exceededData = utilisedData.map((value) =>
    value > 100 ? value - 100 : 0
  );

  const data = [
    { name: "Utilised Budget", data: utilisedStack },
    { name: "Default Budget", data: defaultData },
    { name: "Exceeded Budget", data: exceededData },
  ];

  const optionss = {
    chart: {
      type: "bar",
      toolbar: false,
      stacked: true,
    },
    plotOptions: {
      bar: {
        horizontal: false,
        columnWidth: "35%",
        borderRadius: 3,
        borderRadiusWhenStacked: "all",
        borderRadiusApplication: "end",
      },
    },
    colors: ["#01bf50", "#01411C", "#FF0000"], // Colors for the series
    dataLabels: {
      enabled: true,
      fontSize: "10px",
      formatter: (value, { seriesIndex }) => {
        if (seriesIndex === 1) return "";
        return `${value}%`;
      },
    },
    xaxis: {
      categories: [
        "Apr-24",
        "May-24",
        "Jun-24",
        "Jul-24",
        "Aug-24",
        "Sep-24",
        "Oct-24",
        "Nov-24",
        "Dec-24",
        "Jan-25",
        "Feb-25",
        "Mar-25",
      ],
    },
    yaxis: {
      max: 150,
      labels: {
        formatter: (value) => `${value}%`,
      },
    },
    tooltip: {
      shared: true, // Ensure all series values are shown together
      intersect: false, // Avoid showing individual values for each series separately
      custom: function ({ series, seriesIndex, dataPointIndex, w }) {
        const utilised = utilisedData[dataPointIndex] || 0;
        const exceeded = exceededData[dataPointIndex] || 0;
        const defaultVal = defaultData[dataPointIndex] || 0;

        // Custom tooltip HTML
        return `
        <div style="padding: 10px; font-size: 12px; line-height: 1.5; text-align: left;">
          <strong style="display: block; text-align: center; margin-bottom: 8px;">
            ${w.globals.labels[dataPointIndex]}
          </strong>
          <div style="display: flex; gap:3rem;">
            <span style="flex: 1; text-align: left;">Default Budget:</span>
            <span style="flex: 1; text-align: right;">100%</span>
          </div>
          <div style="display: flex; gap:3rem;">
            <span style="flex: 1; text-align: left;">Utilized Budget:</span>
            <span style="flex: 1; text-align: right;">${utilised}%</span>
          </div>
          <div style="display: flex; gap:3rem;">
            <span style="flex: 1; text-align: left;">Exceeded Budget:</span>
            <span style="flex: 1; text-align: right;">${exceeded}%</span>
          </div>
        </div>
      `;
      },
    },

    legend: {
      show: true,
      position: "top",
    },
  };

  // Transform data into the required format
    const groupedData = hrFinance.reduce((acc, item) => {
      const month = dayjs(item.dueDate).format("MMMM YYYY"); // Extracting month and year
  
      if (!acc[month]) {
        acc[month] = {
          month,
          latestDueDate: item.dueDate, // Store latest due date for sorting
          projectedAmount: 0,
          amount: 0,
          tableData: {
            rows: [],
            columns: [
              { field: "expanseName", headerName: "Expense Name", flex: 1 },
              // { field: "department", headerName: "Department", flex: 200 },
              { field: "expanseType", headerName: "Expense Type", flex: 1 },
              { field: "projectedAmount", headerName: "Amount", flex: 1 },
              { field: "dueDate", headerName: "Due Date", flex: 1 },
              { field: "status", headerName: "Status", flex: 1 },
            ],
          },
        };
      }
  
      acc[month].projectedAmount += item.projectedAmount; // Summing the total projected amount per month
      acc[month].amount += item.projectedAmount; // Summing the total amount per month
      acc[month].tableData.rows.push({
        id: item._id,
        expanseName: item.expanseName,
        department: item.department,
        expanseType: item.expanseType,
        projectedAmount: item.projectedAmount.toFixed(2), // Ensuring two decimal places
        dueDate: dayjs(item.dueDate).format("DD-MM-YYYY"),
        status: item.status,
      });
  
      return acc;
    }, {});

  // Data array for rendering the Accordion
  const financialData = Object.values(groupedData)
     .map((data,index) => {
        
       const transoformedRows = data.tableData.rows.map((row,index)=>({...row,srNo:index+1,projectedAmount:Number(row.projectedAmount.toLocaleString("en-IN").replace(/,/g, "")).toLocaleString("en-IN", { maximumFractionDigits: 0 })}))
       const transformedCols = [
         { field: 'srNo', headerName: 'SR NO', flex: 1 },
         ...data.tableData.columns
       ];
 
       return({
       ...data,
       projectedAmount: data.projectedAmount.toLocaleString("en-IN"), // Ensuring two decimal places for total amount
       amount: data.amount.toLocaleString("en-IN"), // Ensuring two decimal places for total amount
       tableData: {...data.tableData, rows:transoformedRows,columns: transformedCols}
     })
   })
     .sort((a, b) => dayjs(b.latestDueDate).diff(dayjs(a.latestDueDate))); // Sort descending

  return (
    <div className="flex flex-col gap-8">
        <WidgetSection layout={1} title={"BUDGET 2024-25"} border>
          <LayerBarGraph options={optionss} data={data} />
        </WidgetSection>

      <div>
        <WidgetSection layout={3} padding>
          <DataCard
            data={"50K"}
            title={"Projected"}
            description={`Current Month: ${new Date().toLocaleString(
              "default",
              {
                month: "long",
              }
            )}`}
          />
          <DataCard
            data={"45K"}
            title={"Actual"}
            description={`Current Month: ${new Date().toLocaleString(
              "default",
              {
                month: "long",
              }
            )}`}
          />
          <DataCard
            data={7000}
            title={"Requested"}
            description={`Current Month: ${new Date().toLocaleString(
              "default",
              {
                month: "long",
              }
            )}`}
          />
        </WidgetSection>
      </div>

      <div className="flex justify-end">
        <PrimaryButton
          title={"Request Budget"}
          padding="px-5 py-2"
          fontSize="text-base"
        />
      </div>
      
      <AllocatedBudget financialData={financialData}/>
    </div>
  );
};

export default FinanceBudget;
